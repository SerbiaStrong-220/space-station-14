using System.Numerics;
using Content.Client.Message;
using Content.Shared.Anomaly;
using Content.Shared.SS220.Anomaly;
using Robust.Client.AutoGenerated;
using Robust.Client.GameObjects;
using Robust.Client.UserInterface.Controls;
using Robust.Client.UserInterface.XAML;
using Robust.Shared.Timing;
using FancyWindow = Content.Client.UserInterface.Controls.FancyWindow;

namespace Content.Client.Anomaly.Ui;

[GenerateTypedNameReferences]
public sealed partial class AnomalyGeneratorWindow : FancyWindow
{
    [Dependency] private readonly IGameTiming _timing = default!;

    private TimeSpan _cooldownEnd = TimeSpan.Zero;
    private bool _hasEnoughFuel;

    public Action? OnGenerateButtonPressed;

    //ss220 add anomaly place start
    public Action<NetEntity>? OnChooseAnomalyPlace;

    private FancyWindow? _emagWindow;
    //ss220 add anomaly place end

    public AnomalyGeneratorWindow()
    {
        RobustXamlLoader.Load(this);
        IoCManager.InjectDependencies(this);

        EntityView.SpriteOffset = false;

        GenerateButton.OnPressed += _ => OnGenerateButtonPressed?.Invoke();
    }

    //ss220 add anomaly place start
    public override void Close()
    {
        base.Close();
        _emagWindow?.Close();
    }
    //ss220 add anomaly place end

    public void SetEntity(EntityUid uid)
    {
        EntityView.SetEntity(uid);
    }

    public void UpdateState(AnomalyGeneratorUserInterfaceState state)
    {
        _cooldownEnd = state.CooldownEndTime;
        _hasEnoughFuel = state.FuelCost <= state.FuelAmount;

        var fuelCompletion = Math.Clamp((float) state.FuelAmount / state.FuelCost, 0f, 1f);

        FuelBar.Value = fuelCompletion;

        var charges = state.FuelAmount / state.FuelCost;
        FuelText.Text = Loc.GetString("anomaly-generator-charges", ("charges", charges));

        UpdateTimer();
        UpdateReady(); // yes this can trigger twice. no i don't care
    }

    //ss220 add anomaly place start
    public void UpdateEmagState(AnomalyGeneratorEmaggedEventMessage message)
    {
        _emagWindow = new FancyWindow
        {
            MinSize = new Vector2(300, 300),
            Title = Loc.GetString("anomaly-generator-emag-window-title"),
        };

        ChooseAnomalyPlaceButton.Visible = true;
        ChooseAnomalyPlaceButton.OnPressed += _ =>
        {
            var beaconsContainer = new BoxContainer
            {
                Orientation = BoxContainer.LayoutOrientation.Vertical,
                HorizontalAlignment = HAlignment.Center,
                VerticalAlignment = VAlignment.Center,
                HorizontalExpand = true,
                VerticalExpand = true,
                SeparationOverride = 5,
            };

            _emagWindow.AddChild(beaconsContainer);

            foreach (var beacon in message.Beacons)
            {
                var button = new Button
                {
                    StyleClasses = { "OpenBoth" },
                    SetSize = new Vector2(200, 32),
                    Text = beacon.Name,
                };

                button.OnPressed += _ =>
                {
                    if (GenerateButton.Disabled)
                        return;

                    OnChooseAnomalyPlace?.Invoke(beacon.Beacon);
                    ChooseAnomalyPlaceButton.Visible = false;

                    _emagWindow.Close();
                    _emagWindow = null;
                };

                beaconsContainer.AddChild(button);
            }

            _emagWindow.OpenCenteredRight();
        };
    }
    //ss220 add anomaly place end

    public void UpdateTimer()
    {
        if (_timing.CurTime > _cooldownEnd)
        {
            CooldownLabel.SetMarkup(Loc.GetString("anomaly-generator-no-cooldown"));
        }
        else
        {
            var timeLeft = _cooldownEnd - _timing.CurTime;
            var timeString = $"{timeLeft.Minutes:0}:{timeLeft.Seconds:00}";
            CooldownLabel.SetMarkup(Loc.GetString("anomaly-generator-cooldown", ("time", timeString)));
            UpdateReady();
        }
    }

    public void UpdateReady()
    {
        var ready = _hasEnoughFuel && _timing.CurTime > _cooldownEnd;

        var msg = ready
            ? Loc.GetString("anomaly-generator-yes-fire")
            : Loc.GetString("anomaly-generator-no-fire");
        ReadyLabel.SetMarkup(msg);

        GenerateButton.Disabled = !ready;
    }

    protected override void FrameUpdate(FrameEventArgs args)
    {
        base.FrameUpdate(args);

        UpdateTimer();
    }
}

