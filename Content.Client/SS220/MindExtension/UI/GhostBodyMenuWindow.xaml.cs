using Content.Shared.SS220.MindExtension;
using Robust.Client.AutoGenerated;
using Robust.Client.UserInterface.CustomControls;
using Robust.Client.UserInterface.XAML;

namespace Content.Client.SS220.MindExtension.UI;

[GenerateTypedNameReferences]
public sealed partial class GhostBodyMenuWindow : DefaultWindow
{
    private IEnumerable<TrailPoint>? _bodies;
    private Dictionary<NetEntity, GhostBodyCard> BodyCards = new Dictionary<NetEntity, GhostBodyCard>();

    public Action<NetEntity>? FollowBodyAction;
    public Action<NetEntity>? ToBodyAction;

    public GhostBodyMenuWindow()
    {
        RobustXamlLoader.Load(this);
    }

    public void UpdateBodies(IEnumerable<TrailPoint> bodies)
    {
        _bodies = bodies;
    }

    public void Populate()
    {
        BodyList.DisposeAllChildren();
        BodyCards.Clear();
        AddButtons();
    }

    public void DeleteBodyCard(NetEntity entity)
    {
        if (!BodyCards.TryGetValue(entity, out var card))
            return;

        BodyList.RemoveChild(card);
        BodyCards.Remove(entity);
    }

    private void AddButtons()
    {
        foreach (var body in _bodies ?? [])
        {
            var bodyCard = new GhostBodyCard();
            bodyCard.Init(body);

            bodyCard.FollowBodyAction += FollowBodyAction;
            bodyCard.ToBodyAction += ToBodyAction;

            BodyList.AddChild(bodyCard);
            BodyCards.Add(body.Id, bodyCard);
        }
    }
}
