// Â© SS220, An EULA/CLA with a hosting restriction, full text: https://raw.githubusercontent.com/SerbiaStrong-220/space-station-14/master/CLA.txt

using JetBrains.Annotations;
using Robust.Client.AutoGenerated;
using Robust.Client.Console;
using Robust.Client.UserInterface.CustomControls;
using Robust.Client.UserInterface.XAML;
using Robust.Shared.Player;

namespace Content.Client.SS220.Administration.UI.Tabs.AdminTab;

[GenerateTypedNameReferences]
[UsedImplicitly]
public sealed partial class AddObjectiveWindow : DefaultWindow
{
    private ICommonSession? _selectedAntagonist;
    private string _input = string.Empty;
    private string _entityId = string.Empty;

    private string _customName = string.Empty;
    private string _customDesc = string.Empty;
    private string _customIcon = string.Empty;
    private string _customIssuer = string.Empty;

    private bool _customObjective;

    public AddObjectiveWindow()
    {
        RobustXamlLoader.Load(this);
    }

    protected override void EnteredTree()
    {
        ApplyButton.OnPressed += _ => OnApplyButtonPressed(false);
        ForceAssignButton.OnPressed += _ => OnApplyButtonPressed(true);
        ObjectiveLineEdit.OnTextChanged += args =>
        {
            _input = args.Text;
            UpdateInputStates();
        };

        EntityIdLineEdit.OnTextChanged += args =>
        {
            _entityId = args.Text;
            UpdateInputStates();
        };

        CustomObjectiveNameLineEdit.OnTextChanged += args =>
        {
            _customName = args.Text;
            UpdateInputStates();
        };

        CustomObjectiveDescLineEdit.OnTextChanged += args =>
        {
            _customDesc = args.Text;
            UpdateInputStates();
        };

        CustomObjectiveIconLineEdit.OnTextChanged += args =>
        {
            _customIcon = args.Text;
            UpdateInputStates();
        };

        CustomObjectiveIssuerLineEdit.OnTextChanged += args =>
        {
            _customIssuer = args.Text;
            UpdateInputStates();
        };
    }

    private void UpdateInputStates()
    {
        var hasUsualText = !string.IsNullOrWhiteSpace(_input) || !string.IsNullOrWhiteSpace(_entityId);
        var hasCustomText = !string.IsNullOrWhiteSpace(_customName) || !string.IsNullOrWhiteSpace(_customDesc) ||
                            !string.IsNullOrWhiteSpace(_customIcon) || !string.IsNullOrWhiteSpace(_customIssuer);

        UsualObjectiveContainer.Visible = !hasCustomText;
        CustomObjectiveContainer.Visible = !hasUsualText;

        _customObjective = hasCustomText;
    }

    public void SetAntagonist(ICommonSession antagonistPlayerName)
    {
        _selectedAntagonist = antagonistPlayerName;
    }

    private void OnApplyButtonPressed(bool force)
    {
        var clientHost = IoCManager.Resolve<IClientConsoleHost>();

        if (_customObjective)
        {
            if (string.IsNullOrWhiteSpace(_customName))
                return;

            clientHost.ExecuteCommand($"addcustomobjective {_selectedAntagonist} \"{_customName}\" \"{_customDesc}\" \"{_customIcon}\" \"{_customIssuer}\"");
        }
        else
        {
            if (string.IsNullOrWhiteSpace(_input))
                return;

            clientHost.ExecuteCommand($"addobjective {_selectedAntagonist} {_input} {_entityId} {force}");
        }
    }
}
