// Â© SS220, An EULA/CLA with a hosting restriction, full text: https://raw.githubusercontent.com/SerbiaStrong-220/space-station-14/master/CLA.txt
using Content.Client.SS220.UserInterface.Utility;
using Content.Client.SS220.Zones.Systems;
using Content.Client.Stylesheets;
using Content.Shared.SS220.Zones.Components;
using Robust.Client.AutoGenerated;
using Robust.Client.Console;
using Robust.Client.Graphics;
using Robust.Client.UserInterface.Controls;
using Robust.Client.UserInterface.XAML;
using System.Linq;

namespace Content.Client.SS220.Zones.UI;

[GenerateTypedNameReferences]
public sealed partial class ZoneParentEntry : BoxContainer
{
    [Dependency] private readonly IEntityManager _entityManager = default!;
    [Dependency] private readonly IClientConsoleHost _clientConsoleHost = default!;

    private readonly ZonesSystem _zones;

    public EntityUid ZonesParent;

    public Dictionary<EntityUid, ZoneEntry> ZoneEntries = new();

    public Action<ZoneEntry>? ZoneEntryToggled;

    private bool _collapsed;

    private readonly Dictionary<uint, ConfirmableButtonState> _confirmableButtonStates = new()
    {
        [0] = new ConfirmableButtonState(Loc.GetString("zone-container-entry-delete-container-button"), null),
        [1] = new ConfirmableButtonState(Loc.GetString("zones-control-are-you-sure"), StyleNano.ButtonColorCautionDefault)
    };

    public ZoneParentEntry(Entity<ZonesContainerComponent> entity)
    {
        IoCManager.InjectDependencies(this);
        RobustXamlLoader.Load(this);

        _zones = _entityManager.System<ZonesSystem>();
        ZonesParent = entity;

        CollapseButtonTexture.AddStyleClass(OptionButton.StyleClassOptionTriangle);
        ZoneContainerButton.AddStyleClass(ContainerButton.StyleClassButton);
        ZoneContainerButton.OnPressed += _ => _clientConsoleHost.ExecuteCommand($"vv {_entityManager.GetNetEntity(ZonesParent)}");
        CollapseButton.OnPressed += _ => SetCollapsed(!_collapsed);
        ContainerBackgroundPanel.PanelOverride = new StyleBoxFlat { BackgroundColor = Color.FromHex("#2F2F3B") };
        DeleteContainerButton.SetClickState(_confirmableButtonStates);
        DeleteContainerButton.OnConfirmed += () => _zones.ExecuteDeleteZonesContainer(ZonesParent.Owner);

        Refresh();
    }

    public void Refresh()
    {
        ContainerIDLabel.Text = _entityManager.GetNetEntity(ZonesParent).ToString();

        var name = "Unknown";
        if (_entityManager.TryGetComponent<MetaDataComponent>(ZonesParent, out var meta) &&
            !string.IsNullOrEmpty(meta.EntityName) && !string.IsNullOrWhiteSpace(meta.EntityName))
            name = meta.EntityName;

        ContainerNameLabel.Text = name;

        var toDelete = ZoneEntries.ToDictionary();
        var toAdd = new Dictionary<EntityUid, ZoneEntry>();

        foreach (var netEnt in ZonesParent.Comp.Zones)
        {
            if (!_entityManager.TryGetEntity(netEnt, out var entity) ||
                !_entityManager.TryGetComponent<ZoneComponent>(entity, out var zoneComp))
                continue;

            if (!toDelete.Remove(entity.Value))
                toAdd.Add(entity.Value, GetZoneEntry((entity.Value, zoneComp)));
        }

        foreach (var (key, value) in toDelete)
        {
            ZonesBox.RemoveChild(value);
            ZoneEntries.Remove(key);
        }

        foreach (var (key, value) in toAdd)
        {
            ZonesBox.AddChild(value);
            ZoneEntries.Add(key, value);
        }

        SortEntries();

        foreach (var value in ZoneEntries.Values)
            value.Refresh();
    }

    public void SortEntries()
    {
        var sorted = ZoneEntries.OrderBy(e => e.Key.Id).ToDictionary();
        ZonesBox.RemoveAllChildren();
        foreach (var value in sorted.Values)
            ZonesBox.AddChild(value);

        ZoneEntries = sorted;
    }

    public void SetCollapsed(bool value)
    {
        _collapsed = value;
        CollapsibleBox.Visible = !_collapsed;
    }

    public void ApplyFilter(string? filter)
    {
        if (string.IsNullOrEmpty(filter))
        {
            Visible = true;
            ApplyToZoneEntries(null);
            return;
        }

        var containerFiltering = GetFilteringString();
        if (containerFiltering.Contains(filter))
        {
            Visible = true;
            ApplyToZoneEntries(null);
            return;
        }

        Visible = ApplyToZoneEntries(filter);

        bool ApplyToZoneEntries(string? filter)
        {
            var isVisible = false;
            foreach (var entry in ZoneEntries.Values)
            {
                if (string.IsNullOrEmpty(filter))
                {
                    entry.Visible = true;
                    continue;
                }

                var filtering = entry.GetFilteringString();
                var visible = filtering.Contains(filter);
                if (visible)
                    isVisible = true;

                entry.Visible = visible;
            }

            return isVisible;
        }
    }

    public string GetFilteringString()
    {
        return $"{ContainerIDLabel.Text} {ContainerNameLabel.Text}";
    }

    private ZoneEntry GetZoneEntry(Entity<ZoneComponent> entity)
    {
        var entry = new ZoneEntry(entity);
        entry.OnToggled += _ => ZoneEntryToggled?.Invoke(entry);
        return entry;
    }
}
