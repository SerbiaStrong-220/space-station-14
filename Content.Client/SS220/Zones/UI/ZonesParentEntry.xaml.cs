// Â© SS220, An EULA/CLA with a hosting restriction, full text: https://raw.githubusercontent.com/SerbiaStrong-220/space-station-14/master/CLA.txt
using Robust.Client.AutoGenerated;
using Robust.Client.Console;
using Robust.Client.Graphics;
using Robust.Client.UserInterface.Controls;
using Robust.Client.UserInterface.XAML;
using System.Linq;

namespace Content.Client.SS220.Zones.UI;

[GenerateTypedNameReferences]
public sealed partial class ZonesParentEntry : BoxContainer
{
    [Dependency] private readonly IEntityManager _entityManager = default!;
    [Dependency] private readonly IClientConsoleHost _clientConsoleHost = default!;

    public EntityUid ZonesParent;

    public List<ZoneEntry> ZoneEntries = [];

    public Action<ZoneEntry>? ZoneEntryToggled;

    private bool _collapsed;

    public ZonesParentEntry(EntityUid parent, List<ZoneEntry> entries)
    {
        IoCManager.InjectDependencies(this);
        RobustXamlLoader.Load(this);

        ZonesParent = parent;

        CollapseButtonTexture.AddStyleClass(OptionButton.StyleClassOptionTriangle);
        ParentButton.AddStyleClass(ContainerButton.StyleClassButton);
        ParentButton.OnPressed += _ => _clientConsoleHost.ExecuteCommand($"vv {_entityManager.GetNetEntity(ZonesParent)}");
        CollapseButton.OnPressed += _ => SetCollapsed(!_collapsed);
        ParentBackgroundPanel.PanelOverride = new StyleBoxFlat { BackgroundColor = Color.FromHex("#2F2F3B") };

        ZoneEntries = entries;
        Refresh();
    }

    public void Refresh()
    {
        ParentIDLabel.Text = _entityManager.GetNetEntity(ZonesParent).ToString();

        var name = "Unknown";
        if (_entityManager.TryGetComponent<MetaDataComponent>(ZonesParent, out var meta) &&
            !string.IsNullOrEmpty(meta.EntityName) && !string.IsNullOrWhiteSpace(meta.EntityName))
            name = meta.EntityName;

        ParentNameLabel.Text = name;
        SortEntries(refresh: false);

        ZonesBox.RemoveAllChildren();
        foreach (var entry in ZoneEntries)
            ZonesBox.AddChild(entry);

        foreach (var value in ZoneEntries)
            value.Refresh();
    }

    public void SortEntries(bool refresh = true)
    {
        ZoneEntries = [.. ZoneEntries.OrderBy(e => e.ZoneEntity)];

        if (refresh)
            Refresh();
    }

    public void SetCollapsed(bool value)
    {
        _collapsed = value;
        CollapsibleBox.Visible = !_collapsed;
    }

    public void ApplyFilter(string? filter)
    {
        if (string.IsNullOrEmpty(filter))
        {
            Visible = true;
            ApplyToZoneEntries(null);
            return;
        }

        var containerFiltering = GetFilteringString();
        if (containerFiltering.Contains(filter))
        {
            Visible = true;
            ApplyToZoneEntries(null);
            return;
        }

        Visible = ApplyToZoneEntries(filter);

        bool ApplyToZoneEntries(string? filter)
        {
            var isVisible = false;
            foreach (var entry in ZoneEntries)
            {
                if (string.IsNullOrEmpty(filter))
                {
                    entry.Visible = true;
                    continue;
                }

                var filtering = entry.GetFilteringString();
                var visible = filtering.Contains(filter);
                if (visible)
                    isVisible = true;

                entry.Visible = visible;
            }

            return isVisible;
        }
    }

    public string GetFilteringString()
    {
        return $"{ParentIDLabel.Text} {ParentNameLabel.Text}";
    }
}
