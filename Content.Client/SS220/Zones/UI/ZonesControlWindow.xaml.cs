// Â© SS220, An EULA/CLA with a hosting restriction, full text: https://raw.githubusercontent.com/SerbiaStrong-220/space-station-14/master/CLA.txt
using Content.Client.SS220.Zones.Systems;
using Content.Shared.SS220.Zones.Components;
using Robust.Client.AutoGenerated;
using Robust.Client.Graphics;
using Robust.Client.UserInterface.Controls;
using Robust.Client.UserInterface.CustomControls;
using Robust.Client.UserInterface.XAML;
using System.Linq;

namespace Content.Client.SS220.Zones.UI;

[GenerateTypedNameReferences]
public sealed partial class ZonesControlWindow : DefaultWindow
{
    [Dependency] private readonly IEntityManager _entityManager = default!;

    private readonly ZonesSystem _zones;
    private readonly ZonesControlUIController _controller;

    private readonly Dictionary<EntityUid, ZonesParentEntry> _zoneParentEntries = [];
    private readonly Dictionary<EntityUid, ZoneEntry> _zoneEntries = [];

    public ZoneEntry? EditingZoneEntry { get; private set; }

    public ZonesControlWindow()
    {
        IoCManager.InjectDependencies(this);
        RobustXamlLoader.Load(this);

        _zones = _entityManager.System<ZonesSystem>();
        _controller = UserInterfaceManager.GetUIController<ZonesControlUIController>();

        RefreshButton.OnPressed += _ => Refresh();
        OverlayButton.OnToggled += e => _controller.SetOverlay(e.Pressed);
        SearchLineEdit.OnTextChanged += ApplySearchFilter;

        CreateNewZoneButton.OnToggled += e =>
        {
            if (e.Pressed)
                StartCreateZone();
            else
                EndEditing();
        };

        ZoneEditorPanel.PanelOverride = new StyleBoxFlat()
        {
            BorderColor = new Color(96, 96, 96),
            BorderThickness = new Thickness(2)
        };

        ZoneEditor.OnCancel += _ => EndEditing();

        RefreshEntries();
    }

    protected override void EnteredTree()
    {
        base.EnteredTree();

        Refresh();
    }

    protected override void ExitedTree()
    {
        base.ExitedTree();

        EndEditing();
    }

    public void Refresh()
    {
        RefreshEntries();
    }

    private void RefreshEntries()
    {
        foreach (var parentEntry in _zoneParentEntries.Values)
        {
            parentEntry.ZoneEntries.Clear();
            parentEntry.Refresh(); // Clear childs
        }

        var zonesToRemove = _zoneEntries.ToDictionary();
        var query = _entityManager.AllEntityQueryEnumerator<ZoneComponent>();
        while (query.MoveNext(out var uid, out var comp))
        {
            if (_entityManager.Deleted(uid))
                continue;

            var meta = _entityManager.GetComponent<MetaDataComponent>(uid);
            if (meta.EntityLifeStage >= EntityLifeStage.Terminating)
                continue;

            zonesToRemove.Remove(uid);

            if (!_zoneEntries.TryGetValue(uid, out var entry))
            {
                entry = new ZoneEntry((uid, comp));
                entry.OnToggled += _ => OnZoneEntryToggled(entry);
                _zoneEntries.Add(uid, entry);
            }

            var parent = _entityManager.GetComponent<TransformComponent>(uid).ParentUid;
            if (!_zoneParentEntries.TryGetValue(parent, out var parentEntry))
            {
                parentEntry = new ZonesParentEntry(parent, [], refresh: false);
                _zoneParentEntries.Add(parent, parentEntry);
            }

            parentEntry.ZoneEntries.Add(uid, entry);
        }

        foreach (var (uid, entry) in zonesToRemove)
        {
            if (EditingZoneEntry == entry)
                EndEditing();

            _zoneEntries.Remove(uid);
        }

        ZonesParentsContainer.RemoveAllChildren();
        foreach (var (uid, entry) in _zoneParentEntries.OrderBy(e => e.Key))
        {
            if (entry.ZoneEntries.Count <= 0)
            {
                _zoneParentEntries.Remove(uid);
                continue;
            }

            ZonesParentsContainer.AddChild(entry);
            entry.Refresh();
        }
    }

    private void OnZoneEntryToggled(ZoneEntry entry)
    {
        if (EditingZoneEntry == entry)
            EndEditing();
        else
            StartEditZone(entry);
    }

    private void ApplySearchFilter(LineEdit.LineEditEventArgs args)
    {
        foreach (var entry in _zoneParentEntries.Values)
            entry.ApplyFilter(args.Text);
    }

    private void StartCreateZone()
    {
        EndEditing();

        CreateNewZoneButton.Pressed = true;
        ZoneEditor.SetOriginalArgs(null);
        ZoneEditor.SetOverlay(true);
        ZoneEditor.SetEditorSetting(ZoneEditor.ZoneEditorSetting.ReadWrite);
        ZoneEditorPanel.Visible = true;

        ZoneEditor.OnApply += OnCreateZoneApplied;
        SetHeight = Size.Y + GetZoneEditorPanelHeight();
    }

    private void StartEditZone(ZoneEntry entry)
    {
        EndEditing();

        EditingZoneEntry = entry;
        EditingZoneEntry.Pressed = true;

        ZoneEditor.SetOriginalArgs(entry.ZoneEntity);
        ZoneEditor.SetOverlay(true);
        ZoneEditor.SetEditorSetting(ZoneEditor.ZoneEditorSetting.ReadWrite);
        ZoneEditorPanel.Visible = true;

        ZoneEditor.OnApply += OnChangeZoneApplied;
        SetHeight = Size.Y + GetZoneEditorPanelHeight();
    }

    private void EndEditing()
    {
        if (EditingZoneEntry is { } selected)
            selected.Pressed = false;

        EditingZoneEntry = null;

        CreateNewZoneButton.Pressed = false;
        ZoneEditor.SetOverlay(false);
        ZoneEditor.ClearChanges();
        ZoneEditorPanel.Visible = false;

        ZoneEditor.OnApply -= OnCreateZoneApplied;
        ZoneEditor.OnApply -= OnChangeZoneApplied;
        SetHeight = Size.Y - GetZoneEditorPanelHeight();
    }

    private float GetZoneEditorPanelHeight()
    {
        var height = ZoneEditorPanel.Height != 0 ? ZoneEditorPanel.Height : ZoneEditor.DefaultMinSize.Y;
        var yMargin = ZoneEditorPanel.Margin.Bottom + ZoneEditorPanel.Margin.Top;
        return height + yMargin;
    }

    private void OnCreateZoneApplied(ZoneEditor.ZoneArgs args)
    {
        _zones.CreateZoneRequest(
            _entityManager.GetNetEntity(args.Parent),
            args.ProtoId,
            args.Area,
            args.Name,
            args.Color);

        EndEditing();
    }

    private void OnChangeZoneApplied(ZoneEditor.ZoneArgs args)
    {
        if (EditingZoneEntry?.ZoneEntity is { } zone)
        {
            _zones.ChangeZoneRequest(
                _entityManager.GetNetEntity(zone),
                _entityManager.GetNetEntity(args.Parent),
                args.ProtoId,
                args.Area,
                args.Name,
                args.Color);
        }

        EndEditing();
    }
}
