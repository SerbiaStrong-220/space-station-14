// Â© SS220, An EULA/CLA with a hosting restriction, full text: https://raw.githubusercontent.com/SerbiaStrong-220/space-station-14/master/CLA.txt
using Content.Client.SS220.Zones.Systems;
using Content.Shared.SS220.Zones.Components;
using Robust.Client.AutoGenerated;
using Robust.Client.Graphics;
using Robust.Client.UserInterface.Controls;
using Robust.Client.UserInterface.CustomControls;
using Robust.Client.UserInterface.XAML;
using System.Linq;

namespace Content.Client.SS220.Zones.UI;

[GenerateTypedNameReferences]
public sealed partial class ZonesControlWindow : DefaultWindow
{
    [Dependency] private readonly IEntityManager _entityManager = default!;

    private readonly ZonesSystem _zones;

    private Dictionary<EntityUid, EntityUid> _zoneParents = [];
    private Dictionary<EntityUid, ZonesParentEntry> _zoneParentEntries = [];

    public ZoneEntry? EditingZoneEntry { get; private set; }

    public ZonesControlWindow()
    {
        IoCManager.InjectDependencies(this);
        RobustXamlLoader.Load(this);

        _zones = _entityManager.System<ZonesSystem>();

        RefreshButton.OnPressed += _ => Refresh();
        OverlayButton.OnToggled += e => _zones.SetOverlay(e.Pressed);
        SearchLineEdit.OnTextChanged += ApplySearchFilter;

        CreateNewZoneButton.OnToggled += e =>
        {
            if (e.Pressed)
                StartCreateZone();
            else
                EndEditing();
        };

        ZoneEditorPanel.PanelOverride = new StyleBoxFlat()
        {
            BorderColor = new Color(96, 96, 96),
            BorderThickness = new Thickness(2)
        };

        ZoneEditor.OnCancel += _ => EndEditing();

        RefreshEntries();
    }

    protected override void EnteredTree()
    {
        base.EnteredTree();

        Refresh();
    }

    protected override void ExitedTree()
    {
        base.ExitedTree();

        EndEditing();
    }

    public void Refresh()
    {
        RefreshEntries();
    }

    private void RefreshEntries()
    {
        var toRemove = _zoneParentEntries.SelectMany(x => x.Value.ZoneEntries).ToDictionary();
        var toAdd = new Dictionary<EntityUid, ZoneEntry>();

        var query = _entityManager.AllEntityQueryEnumerator<ZoneComponent>();
        while (query.MoveNext(out var uid, out var comp))
        {
            if (_entityManager.Deleted(uid))
                continue;

            if (!toRemove.Remove(uid))
                toAdd.Add(uid, GetZoneEntry((uid, comp)));
        }

        foreach (var (key, value) in toRemove)
        {
            if (EditingZoneEntry == value)
                EndEditing();

            var parent = _zones.GetZoneParent(key);
            if (_zoneParentEntries.TryGetValue(parent, out var entry))
                entry.ZoneEntries.Remove(key);
        }

        foreach (var (key, value) in toAdd)
        {
            var parent = _zones.GetZoneParent(key);
            if (_zoneParentEntries.TryGetValue(parent, out var entry))
                entry.ZoneEntries.Add(key, value);
            else
                _zoneParentEntries[parent] = new ZonesParentEntry(parent, new() { value });
        }

        SortParentEntries(refresh: false);

        ZonesParentsContainer.RemoveAllChildren();
        foreach (var (uid, entry) in _zoneParentEntries.ToDictionary())
        {
            if (entry.ZoneEntries.Count <= 0)
            {
                _zoneParentEntries.Remove(uid);
                continue;
            }

            ZonesParentsContainer.AddChild(entry);
            entry.Refresh();
        }
    }

    public void SortParentEntries(bool refresh = true)
    {
        _zoneParentEntries = _zoneParentEntries.OrderBy(e => e.Key).ToDictionary();

        if (refresh)
            RefreshEntries();
    }

    private ZoneEntry GetZoneEntry(Entity<ZoneComponent> entity)
    {
        var entry = new ZoneEntry(entity);
        entry.OnToggled += _ => OnZoneEntryToggled(entry);
        return entry;
    }

    private void OnZoneEntryToggled(ZoneEntry entry)
    {
        if (EditingZoneEntry == entry)
            EndEditing();
        else
            StartEditZone(entry);
    }

    private void ApplySearchFilter(LineEdit.LineEditEventArgs args)
    {
        foreach (var entry in _zoneParentEntries.Values)
            entry.ApplyFilter(args.Text);
    }

    private void StartCreateZone()
    {
        EndEditing();

        CreateNewZoneButton.Pressed = true;
        ZoneEditor.SetOriginalParams(null);
        ZoneEditor.SetOverlay(true);
        ZoneEditor.SetEditorSetting(ZoneEditor.ZoneEditorSetting.ReadWrite);
        ZoneEditorPanel.Visible = true;

        ZoneEditor.OnApply += OnCreateZoneApplied;
    }

    private void StartEditZone(ZoneEntry entry)
    {
        EndEditing();

        EditingZoneEntry = entry;
        EditingZoneEntry.Pressed = true;

        ZoneEditor.SetOriginalParams(entry.ZoneEntity);
        ZoneEditor.SetOverlay(true);
        ZoneEditor.SetEditorSetting(ZoneEditor.ZoneEditorSetting.ReadWrite);
        ZoneEditorPanel.Visible = true;

        ZoneEditor.OnApply += OnChangeZoneApplied;
    }

    private void EndEditing()
    {
        if (EditingZoneEntry is { } selected)
            selected.Pressed = false;

        EditingZoneEntry = null;

        CreateNewZoneButton.Pressed = false;
        ZoneEditor.SetOverlay(false);
        ZoneEditor.ClearChanges();
        ZoneEditorPanel.Visible = false;

        ZoneEditor.OnApply -= OnCreateZoneApplied;
        ZoneEditor.OnApply -= OnChangeZoneApplied;
    }

    private void OnCreateZoneApplied(ZoneEditor.ZoneParams @params)
    {
        _zones.CreateZoneRequest(
            _entityManager.GetNetEntity(@params.Parent),
            @params.ProtoId,
            @params.Area,
            @params.Name,
            @params.Color,
            @params.AttachToLattice);

        EndEditing();
    }

    private void OnChangeZoneApplied(ZoneEditor.ZoneParams @params)
    {
        if (EditingZoneEntry?.ZoneEntity is { } zone)
        {
            _zones.ChangeZoneRequest(
                _entityManager.GetNetEntity(zone),
                _entityManager.GetNetEntity(@params.Parent),
                @params.ProtoId,
                @params.Area,
                @params.Name,
                @params.Color,
                @params.AttachToLattice);
        }

        EndEditing();
    }
}
