using Content.Client.Mech;
using Content.Client.UserInterface.Controls;
using Content.Client.UserInterface.Fragments;
using Content.Shared.FixedPoint;
using Content.Shared.Mech.Components;
using Content.Shared.SS220.AltMech;
using Content.Shared.SS220.Mech.Components;
using Content.Shared.SS220.Mech.Equipment.Components;
using Robust.Client.AutoGenerated;
using Robust.Client.GameObjects;
using Robust.Client.UserInterface.Controls;
using Robust.Client.UserInterface.XAML;
using Robust.Shared.Containers;
using static Robust.Client.UserInterface.Controls.MenuBar;

namespace Content.Client.SS220.Mech.Ui;

[GenerateTypedNameReferences]
public sealed partial class AltMechMenu : FancyWindow
{
    public event Action<string>? OnRemovePartButtonPressed;

    [Dependency] private readonly IEntityManager _ent = default!;

    private EntityUid _mech;

    public event Action<EntityUid>? OnRemoveButtonPressed;

    public AltMechMenu()
    {
        RobustXamlLoader.Load(this);
        IoCManager.InjectDependencies(this);

        spriteViewDict[MechPartVisualLayers.Core] = MechViewCore;
        spriteViewDict[MechPartVisualLayers.Head] = MechViewHead;
        spriteViewDict[MechPartVisualLayers.RightArm] = MechViewRightArm;
        spriteViewDict[MechPartVisualLayers.LeftArm] = MechViewLeftArm;
        spriteViewDict[MechPartVisualLayers.Chassis] = MechViewChassis;
        spriteViewDict[MechPartVisualLayers.Power] = MechViewPower;

        integrityBarDict[IntegrityDisplayBarCore] = "core";
        integrityBarDict[IntegrityDisplayBarHead] = "head";
        integrityBarDict[IntegrityDisplayBarRightArm] = "right-arm";
        integrityBarDict[IntegrityDisplayBarLeftArm] = "left-arm";
        integrityBarDict[IntegrityDisplayBarChassis] = "chassis";
        integrityBarDict[IntegrityDisplayBarPower] = "power";

        spriteTextDict[IntegrityDisplayCore] = "core";
        spriteTextDict[IntegrityDisplayHead] = "head";
        spriteTextDict[IntegrityDisplayRightArm] = "right-arm";
        spriteTextDict[IntegrityDisplayLeftArm] = "left-arm";
        spriteTextDict[IntegrityDisplayChassis] = "chassis";
        spriteTextDict[IntegrityDisplayPower] = "power";

        buttonDict[RemoveButtonHead] = "head";
        buttonDict[RemoveButtonRightArm] = "right-arm";
        buttonDict[RemoveButtonLeftArm] = "left-arm";
        buttonDict[RemoveButtonChassis] = "chassis";
        buttonDict[RemoveButtonPower] = "power";

        foreach (var key in buttonDict.Keys)
        {
            key.TexturePath = "/Textures/Interface/Nano/cross.svg.png";
            key.OnPressed += _ => OnRemovePartButtonPressed?.Invoke(buttonDict[key]);
        }
    }

    public readonly Dictionary<MechPartVisualLayers, SpriteView?> spriteViewDict = new Dictionary<MechPartVisualLayers, SpriteView?>()
    {
        [MechPartVisualLayers.Core] = null,
        [MechPartVisualLayers.Head] = null,
        [MechPartVisualLayers.RightArm] = null,
        [MechPartVisualLayers.LeftArm] = null,
        [MechPartVisualLayers.Chassis] = null,
        [MechPartVisualLayers.Power] = null
    };

    public readonly Dictionary<ProgressBar, string> integrityBarDict = new Dictionary<ProgressBar, string>();

    public readonly Dictionary<Label, string> spriteTextDict = new Dictionary<Label, string>();

    public Dictionary<TextureButton, string> buttonDict = new Dictionary<TextureButton, string>();

    public readonly Dictionary<string, MechPartVisualLayers> partsVisuals = new Dictionary<string, MechPartVisualLayers>()
    {
        ["core"] = MechPartVisualLayers.Core,
        ["head"] = MechPartVisualLayers.Head,
        ["right-arm"] = MechPartVisualLayers.RightArm,
        ["left-arm"] = MechPartVisualLayers.LeftArm,
        ["chassis"] = MechPartVisualLayers.Chassis,
        ["power"] = MechPartVisualLayers.Power
    };

    public void SetEntity(EntityUid? uid, MechPartVisualLayers part)
    {
        if (!spriteViewDict.ContainsKey(part))
            return;

        var view = spriteViewDict[part];

        if (view != null)
            view.SetEntity(uid);

        if (uid == null)
            return;

        if(_ent.TryGetComponent<AltMechComponent>(uid, out var mechComp))
            _mech = (EntityUid)uid;
    }

    public void UpdateMechStats()
    {
        if (!_ent.TryGetComponent<AltMechComponent>(_mech, out var mechComp))
            return;

        //var localPartDict = new Dictionary<string, EntityUid?>();

        //foreach (var pair in state.Parts)
        //{
        //    _ent.TryGetEntity(pair.Value, out var entity);
        //    localPartDict.Add(pair.Key, entity);
        //}

        var integrityPercent = mechComp.Integrity / mechComp.MaxIntegrity;
        IntegrityDisplayBarCore.Value = integrityPercent.Float();
        IntegrityDisplayCore.Text = Loc.GetString("mech-integrity-display", ("amount", (integrityPercent*100).Int()));

        foreach (var bar in integrityBarDict.Keys)
        {
            if (integrityBarDict[bar] == "core")
                continue;

            FixedPoint2 partintegrityPercent;
            if (mechComp.ContainerDict[integrityBarDict[bar]].ContainedEntity == null || !_ent.TryGetComponent<MechPartComponent>(mechComp.ContainerDict[integrityBarDict[bar]].ContainedEntity, out var partComp) || partComp.PartOwner==null)
            {
                partintegrityPercent = 0;
                bar.Value = partintegrityPercent.Float();
                continue;
            }

            partintegrityPercent = partComp.Integrity / partComp.MaxIntegrity;
            bar.Value = partintegrityPercent.Float();
        }

        foreach (var text in spriteTextDict.Keys)
        {
            if (spriteTextDict[text] == "core")
                continue;

            if (mechComp.ContainerDict[spriteTextDict[text]].ContainedEntity == null || !_ent.TryGetComponent<MechPartComponent>(mechComp.ContainerDict[spriteTextDict[text]].ContainedEntity, out var partComp) || partComp.PartOwner == null)
            {
                text.Text = Loc.GetString("mech-integrity-display", ("amount", 0));
                continue;
            }

            var partintegrityPercent = partComp.Integrity / partComp.MaxIntegrity;
            text.Text = Loc.GetString("mech-integrity-display", ("amount", (partintegrityPercent * 100).Int()));
        }
            
        if (mechComp.MaxEnergy != 0f)
        {
            var energyPercent = mechComp.Energy / mechComp.MaxEnergy;
            EnergyDisplayBar.Value = energyPercent.Float();
            EnergyDisplay.Text = Loc.GetString("mech-energy-display", ("amount", (energyPercent*100).Int()));
        }
        else
        {
            EnergyDisplayBar.Value = 0f;
            EnergyDisplay.Text = Loc.GetString("mech-energy-missing");
        }

        foreach (var part in mechComp.ContainerDict)
        {
            SetEntity(part.Value.ContainedEntity, partsVisuals[part.Key]);
        }
        //if (_ent.TryGetComponent<MechPartComponent>(_mech, out var partComp))
        //{
        //    SlotDisplay.Text = Loc.GetString("mech-slot-display",
        //        ("amount", partComp.MaxEquipmentAmount - partComp.EquipmentContainer.ContainedEntities.Count));
        //}

    }

    public void UpdateEquipmentView()
    {
        //if (!_ent.TryGetComponent<AltMechComponent>(_mech, out var mechComp))
        //    return;

        //EquipmentControlContainer.Children.Clear();
        //if (!_ent.TryGetComponent<MechPartComponent>(_mech, out var partCore))
        //    return;
        //foreach (var ent in partCore.EquipmentContainer.ContainedEntities)
        //{
        //    if (!_ent.TryGetComponent<MetaDataComponent>(ent, out var metaData))
        //        continue;

        //    var uicomp = _ent.GetComponentOrNull<UIFragmentComponent>(ent);
        //    var ui = uicomp?.Ui?.GetUIFragmentRoot();

        //    var control = new AltMechEquipmentControl(ent, metaData.EntityName, ui);

        //    control.OnRemoveButtonPressed += () => OnRemoveButtonPressed?.Invoke(ent);

        //    EquipmentControlContainer.AddChild(control);
        //}
        //foreach (var ent in mechComp.ContainerDict.Values)
        //{
        //    if (!_ent.TryGetComponent<MechPartComponent>(ent.ContainedEntity, out var part))
        //        continue;
        //    foreach (var equipment in part.EquipmentContainer.ContainedEntities)
        //    {
        //        if (!_ent.TryGetComponent<MetaDataComponent>(equipment, out var metaData))
        //            continue;

        //        var uicomp = _ent.GetComponentOrNull<UIFragmentComponent>(equipment);
        //        var ui = uicomp?.Ui?.GetUIFragmentRoot();

        //        var control = new AltMechEquipmentControl(equipment, metaData.EntityName, ui);

        //        control.OnRemoveButtonPressed += () => OnRemoveButtonPressed?.Invoke(equipment);

        //        EquipmentControlContainer.AddChild(control);
        //    }
        //}
    }
}

